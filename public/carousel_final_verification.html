<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轮播图功能最终验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 30px;
        }
        .carousel-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 30px 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 1;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carousel-slide.active {
            opacity: 1;
            z-index: 2;
        }
        .carousel-indicators {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 3;
        }
        .carousel-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .carousel-indicator.active {
            background-color: #333;
        }
        .log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #34495e;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #95a5a6;
            margin-right: 10px;
        }
        .log-info {
            color: #ecf0f1;
        }
        .log-success {
            color: #2ecc71;
        }
        .log-error {
            color: #e74c3c;
        }
        .code-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-controls {
            margin: 20px 0;
        }
        .btn {
            padding: 10px 20px;
            margin: 0 10px 10px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .debug-vars {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
            margin: 15px 0;
        }
        .debug-var {
            margin: 5px 0;
        }
        .image-status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .carousel-placeholder {
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            position: absolute;
            top: 0;
            left: 0;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .verification-steps {
            margin: 30px 0;
        }
        .verification-step {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        .verification-step.passed {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        .verification-step.failed {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>轮播图功能最终验证</h1>
        
        <div class="status-box status-info">
            <p>此页面用于最终验证轮播图的完整功能，包括：</p>
            <ul>
                <li>每5秒自动切换到下一张图片</li>
                <li>第三张图片显示5秒后正确回到第一张图片</li>
                <li>指示器点击功能正常工作</li>
                <li>图片正确加载和显示</li>
            </ul>
        </div>
        
        <h2>1. 轮播图演示</h2>
        <div class="carousel-container" id="carouselContainer">
            <div class="carousel-slide">
                <div class="carousel-placeholder" id="placeholder1">
                    <div class="loading-spinner"></div>
                    <p>加载中...</p>
                </div>
                <img src="" data-src="/images_new/lunbotu/4141ab88-6dc1-4253-94d8-f4692ab7272f.png" alt="轮播图片1" class="carousel-image">
            </div>
            <div class="carousel-slide">
                <div class="carousel-placeholder" id="placeholder2">
                    <div class="loading-spinner"></div>
                    <p>加载中...</p>
                </div>
                <img src="" data-src="/images_new/lunbotu/4c97ca9f-75a1-48b3-a48a-b1c609933793.webp" alt="轮播图片2" class="carousel-image">
            </div>
            <div class="carousel-slide">
                <div class="carousel-placeholder" id="placeholder3">
                    <div class="loading-spinner"></div>
                    <p>加载中...</p>
                </div>
                <img src="" data-src="/images_new/lunbotu/微信图片_20250825105422.png" alt="轮播图片3" class="carousel-image">
            </div>
            <div class="carousel-indicators">
                <span class="carousel-indicator"></span>
                <span class="carousel-indicator"></span>
                <span class="carousel-indicator"></span>
            </div>
        </div>
        
        <div class="image-status">
            <p>图片加载状态将显示在这里...</p>
        </div>
        
        <div class="test-controls">
            <button id="startBtn" class="btn btn-primary">开始轮播</button>
            <button id="stopBtn" class="btn btn-danger">停止轮播</button>
            <button id="resetBtn" class="btn btn-primary">重置轮播</button>
        </div>
        
        <h2>2. 轮播图核心代码</h2>
        <div class="code-section">
// 轮播图循环逻辑 (修复后)
function startCarousel() {
  // 自动轮播
  let intervalId = setInterval(() => {
    console.log(`当前索引: ${currentIndex}, 幻灯片数量: ${slides.length}`);
    const nextIndex = (currentIndex + 1) % slides.length;
    console.log(`计算下一张索引: (${currentIndex} + 1) % ${slides.length} = ${nextIndex}`);
    
    // 特别检查从最后一张到第一张的循环
    if (currentIndex === slides.length - 1) {
      console.log(`检测到循环点: 从第${slides.length}张到第1张`);
    }
    
    currentIndex = nextIndex;
    showSlide(currentIndex);
  }, 5000);
  
  // 指示器点击事件包含相同的逻辑...
}
        </div>
        
        <h2>3. 验证步骤</h2>
        <div class="verification-steps">
            <div class="verification-step" id="step1">
                <strong>步骤 1:</strong> 页面加载后，第一张图片应该显示，并且轮播应该自动开始
            </div>
            <div class="verification-step" id="step2">
                <strong>步骤 2:</strong> 5秒后，应该自动切换到第二张图片
            </div>
            <div class="verification-step" id="step3">
                <strong>步骤 3:</strong> 再经过5秒后，应该自动切换到第三张图片
            </div>
            <div class="verification-step" id="step4">
                <strong>步骤 4 (关键):</strong> 再经过5秒后，应该从第三张图片正确切换回第一张图片，完成一个完整循环
            </div>
            <div class="verification-step" id="step5">
                <strong>步骤 5:</strong> 点击指示器应该能手动切换到对应的图片，并且自动轮播应该继续从新的位置开始
            </div>
        </div>
        
        <h2>4. 调试信息</h2>
        <div class="debug-vars">
            <div class="debug-var">
                <strong>slides.length:</strong> <span id="slidesLength">3</span>
            </div>
            <div class="debug-var">
                <strong>currentIndex:</strong> <span id="currentIndex">0</span>
            </div>
            <div class="debug-var">
                <strong>轮播状态:</strong> <span id="carouselStatus">未启动</span>
            </div>
            <div class="debug-var">
                <strong>已完成循环次数:</strong> <span id="cycleCount">0</span>
            </div>
        </div>
        
        <h2>5. 验证日志</h2>
        <div class="log-container" id="logContainer">
            <div class="log-entry">
                <span class="log-time">[${new Date().toLocaleTimeString()}]</span>
                <span class="log-info">验证页面已加载，开始初始化...</span>
            </div>
        </div>
        
        <h2>6. 验证结果</h2>
        <div id="verificationResult" class="status-box status-info">
            <p>验证尚未开始。轮播将在页面加载后自动开始，或者点击"开始轮播"按钮手动启动。</p>
        </div>
    </div>

    <script>
        // 初始化变量
        let currentIndex = 0;
        let intervalId = null;
        let cycleCount = 0;
        let verificationSteps = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false
        };
        
        // 获取DOM元素
        const container = document.getElementById('carouselContainer');
        const slides = document.querySelectorAll('.carousel-slide');
        const indicators = document.querySelectorAll('.carousel-indicator');
        const logContainer = document.getElementById('logContainer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const slidesLengthElement = document.getElementById('slidesLength');
        const currentIndexElement = document.getElementById('currentIndex');
        const carouselStatusElement = document.getElementById('carouselStatus');
        const cycleCountElement = document.getElementById('cycleCount');
        const verificationResultElement = document.getElementById('verificationResult');
        const imageStatusElement = document.querySelector('.image-status');
        
        // 初始化步骤元素
        const stepElements = {
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            step4: document.getElementById('step4'),
            step5: document.getElementById('step5')
        };
        
        // 预加载图片函数
        function preloadImages() {
            log('开始预加载轮播图片...');
            const imagePromises = Array.from({ length: 3 }, (_, index) => {
                return new Promise((resolve, reject) => {
                    const imgId = index + 1;
                    const placeholderId = `placeholder${imgId}`;
                    const img = slides[index].querySelector('.carousel-image');
                    const placeholder = document.getElementById(placeholderId);
                    
                    if (img && placeholder) {
                        const imgSrc = img.getAttribute('data-src');
                        log(`预加载图片 ${imgId}: ${imgSrc}`);
                        
                        // 创建新的Image对象进行预加载
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            log(`成功: 图片 ${imgId} 预加载完成`, 'success');
                            
                            // 替换原始图片的src并显示它
                            img.src = imgSrc;
                            img.style.display = 'block';
                            
                            // 隐藏占位符
                            placeholder.style.display = 'none';
                            
                            resolve(img);
                        };
                        
                        tempImg.onerror = function() {
                            log(`错误: 图片 ${imgId} 预加载失败: ${imgSrc}`, 'error');
                            placeholder.textContent = `图片加载失败`;
                            placeholder.style.backgroundColor = '#ffebee';
                            placeholder.style.color = '#c62828';
                            
                            reject(new Error(`无法加载图片 ${imgId}`));
                        };
                        
                        tempImg.src = imgSrc;
                    } else {
                        log(`错误: 未找到图片元素或占位符 ${imgId}`, 'error');
                        reject(new Error(`未找到图片元素或占位符 ${imgId}`));
                    }
                });
            });
            
            // 等待所有图片加载完成或失败
            Promise.allSettled(imagePromises).then(results => {
                log('所有图片预加载完成');
                
                // 显示图片加载状态
                let loadedCount = 0;
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        loadedCount++;
                    }
                });
                
                imageStatusElement.textContent = `图片加载状态: ${loadedCount}/${results.length} 张图片成功加载`;
                
                // 初始化轮播
                initCarousel();
            });
        }
        
        // 初始化轮播
        function initCarousel() {
            // 设置幻灯片样式
            slides.forEach((slide, index) => {
                slide.style.position = 'absolute';
                slide.style.top = '0';
                slide.style.left = '0';
                slide.style.width = '100%';
                slide.style.height = '100%';
                slide.style.opacity = index === 0 ? '1' : '0';
                slide.style.zIndex = index === 0 ? '2' : '1';
                slide.style.transition = 'opacity 0.5s ease-in-out';
                slide.style.display = 'block';
            });
            
            // 显示第一张幻灯片
            showSlide(0);
            
            // 标记步骤1完成
            verificationSteps.step1 = true;
            updateStepStatus('step1');
            
            // 自动开始轮播
            startCarousel();
        }
        
        // 显示指定幻灯片
        function showSlide(index) {
            // 确保索引在有效范围内
            index = Math.max(0, Math.min(index, slides.length - 1));
            currentIndex = index;
            
            // 更新显示的幻灯片
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
                slide.style.opacity = i === index ? '1' : '0';
                slide.style.zIndex = i === index ? '2' : '1';
            });
            
            // 更新指示器
            indicators.forEach((indicator, i) => {
                indicator.classList.toggle('active', i === index);
                indicator.style.backgroundColor = i === index ? '#333' : '#ccc';
            });
            
            // 更新调试变量显示
            currentIndexElement.textContent = currentIndex;
            
            // 记录日志
            log(`切换到幻灯片 ${index + 1}`);
            
            // 根据当前索引更新验证步骤状态
            if (index === 1 && !verificationSteps.step2) {
                verificationSteps.step2 = true;
                updateStepStatus('step2');
            } else if (index === 2 && !verificationSteps.step3) {
                verificationSteps.step3 = true;
                updateStepStatus('step3');
            } else if (index === 0 && cycleCount > 0 && !verificationSteps.step4) {
                // 检测到从第三张回到第一张的循环
                verificationSteps.step4 = true;
                updateStepStatus('step4');
                log(`成功: 轮播图从第三张正确回到了第一张图片！`, 'success');
            }
            
            // 如果是第三张图片，增加循环计数
            if (index === slides.length - 1) {
                log(`到达最后一张图片 (第${index + 1}张)，5秒后应该回到第一张图片`);
            } else if (index === 0 && cycleCount > 0) {
                // 完成一个循环
                cycleCount++;
                cycleCountElement.textContent = cycleCount;
                log(`完成第 ${cycleCount} 次循环`, 'success');
            }
            
            // 检查是否所有验证步骤都已完成
            checkVerificationComplete();
        }
        
        // 开始轮播
        function startCarousel() {
            if (intervalId) {
                clearInterval(intervalId);
            }
            
            // 自动轮播 - 每5秒切换一次
            intervalId = setInterval(() => {
                console.log(`当前索引: ${currentIndex}, 幻灯片数量: ${slides.length}`);
                const nextIndex = (currentIndex + 1) % slides.length;
                console.log(`计算下一张索引: (${currentIndex} + 1) % ${slides.length} = ${nextIndex}`);
                
                // 特别检查从最后一张到第一张的循环
                if (currentIndex === slides.length - 1) {
                    console.log(`检测到循环点: 从第${slides.length}张到第1张`);
                    log(`检测到循环点: 从第${slides.length}张到第1张`);
                    // 标记进入循环点
                    if (cycleCount === 0) {
                        cycleCount = 1;
                        cycleCountElement.textContent = cycleCount;
                    }
                }
                
                currentIndex = nextIndex;
                showSlide(currentIndex);
            }, 5000);
            
            log('启动自动轮播 (5秒间隔)');
            carouselStatusElement.textContent = '运行中';
        }
        
        // 停止轮播
        function stopCarousel() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                log('停止自动轮播');
                carouselStatusElement.textContent = '已停止';
            }
        }
        
        // 重置轮播
        function resetCarousel() {
            stopCarousel();
            currentIndex = 0;
            cycleCount = 0;
            
            // 重置验证步骤
            verificationSteps = {
                step1: false,
                step2: false,
                step3: false,
                step4: false,
                step5: false
            };
            
            // 重置步骤状态显示
            for (const step in stepElements) {
                updateStepStatus(step);
            }
            
            showSlide(0);
            log('重置轮播');
            
            slidesLengthElement.textContent = slides.length;
            currentIndexElement.textContent = currentIndex;
            cycleCountElement.textContent = cycleCount;
            
            verificationResultElement.className = 'status-box status-info';
            verificationResultElement.innerHTML = '<p>轮播已重置。点击"开始轮播"按钮重新开始验证。</p>';
        }
        
        // 添加日志
        function log(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            logEntry.innerHTML = `
                <span class="log-time">[${timeString}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 更新验证步骤状态
        function updateStepStatus(stepName) {
            if (stepElements[stepName]) {
                if (verificationSteps[stepName]) {
                    stepElements[stepName].className = 'verification-step passed';
                    stepElements[stepName].innerHTML = stepElements[stepName].innerHTML + ' <strong>✓ 通过</strong>';
                } else {
                    stepElements[stepName].className = 'verification-step';
                }
            }
        }
        
        // 检查验证是否完成
        function checkVerificationComplete() {
            // 检查关键步骤是否通过（步骤1-4）
            const criticalStepsPassed = verificationSteps.step1 && 
                                      verificationSteps.step2 && 
                                      verificationSteps.step3 && 
                                      verificationSteps.step4;
            
            if (criticalStepsPassed) {
                verificationResultElement.className = 'status-box status-success';
                verificationResultElement.innerHTML = '<p>验证成功: 轮播图功能正常工作！特别是第三张图片5秒后能正确回到第一张图片。</p>';
                log('验证完成 - 所有关键功能测试通过！', 'success');
            }
        }
        
        // 绑定事件处理程序
        startBtn.addEventListener('click', startCarousel);
        stopBtn.addEventListener('click', stopCarousel);
        resetBtn.addEventListener('click', resetCarousel);
        
        // 为指示器添加点击事件
        indicators.forEach((indicator, index) => {
            // 确保指示器有合适的样式
            indicator.style.width = '12px';
            indicator.style.height = '12px';
            indicator.style.borderRadius = '50%';
            indicator.style.cursor = 'pointer';
            indicator.style.margin = '0 5px';
            indicator.style.backgroundColor = index === 0 ? '#333' : '#ccc';
            indicator.style.display = 'inline-block';
            indicator.style.border = 'none';
            indicator.style.padding = '0';
            
            indicator.addEventListener('click', () => {
                log(`点击指示器 ${index + 1}`);
                currentIndex = index;
                showSlide(currentIndex);
                
                // 标记步骤5完成
                verificationSteps.step5 = true;
                updateStepStatus('step5');
                
                // 重置自动轮播计时器
                clearInterval(intervalId);
                intervalId = setInterval(() => {
                    console.log(`当前索引: ${currentIndex}, 幻灯片数量: ${slides.length}`);
                    const nextIndex = (currentIndex + 1) % slides.length;
                    console.log(`计算下一张索引: (${currentIndex} + 1) % ${slides.length} = ${nextIndex}`);
                    
                    // 特别检查从最后一张到第一张的循环
                    if (currentIndex === slides.length - 1) {
                        console.log(`检测到循环点: 从第${slides.length}张到第1张`);
                        log(`检测到循环点: 从第${slides.length}张到第1张`);
                    }
                    
                    currentIndex = nextIndex;
                    showSlide(currentIndex);
                }, 5000);
            });
        });
        
        // 初始化
        slidesLengthElement.textContent = slides.length;
        
        // 页面加载完成后开始预加载图片
        window.addEventListener('load', function() {
            log('页面加载完成，开始初始化轮播验证');
            preloadImages();
        });
    </script>
</body>
</html>