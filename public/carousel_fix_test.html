<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轮播图循环修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 30px;
        }
        .carousel-test {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 30px 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .carousel-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 1;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
        }
        .carousel-slide:nth-child(1) {
            background-color: #e74c3c;
        }
        .carousel-slide:nth-child(2) {
            background-color: #3498db;
        }
        .carousel-slide:nth-child(3) {
            background-color: #2ecc71;
        }
        .carousel-slide.active {
            opacity: 1;
            z-index: 2;
        }
        .carousel-indicators {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 3;
        }
        .carousel-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .carousel-indicator.active {
            background-color: #333;
        }
        .log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #34495e;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #95a5a6;
            margin-right: 10px;
        }
        .log-info {
            color: #ecf0f1;
        }
        .log-success {
            color: #2ecc71;
        }
        .log-error {
            color: #e74c3c;
        }
        .code-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-controls {
            margin: 20px 0;
        }
        .btn {
            padding: 10px 20px;
            margin: 0 10px 10px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .debug-vars {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
            margin: 15px 0;
        }
        .debug-var {
            margin: 5px 0;
        }
        .simulation-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .simulation-step {
            margin: 15px 0;
            padding: 10px;
            border-left: 3px solid #3498db;
            background-color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>轮播图循环修复测试</h1>
        
        <div class="status-box status-info">
            <p>此页面用于测试轮播图的循环功能，验证从第三张图片到第一张图片的切换是否正常工作。</p>
            <p>修复策略：添加了详细的索引计算日志，并确保模运算正确应用于轮播图切换逻辑。</p>
        </div>
        
        <h2>1. 轮播图模拟</h2>
        <div class="carousel-test" id="carouselTest">
            <div class="carousel-slide">图片 1</div>
            <div class="carousel-slide">图片 2</div>
            <div class="carousel-slide">图片 3</div>
            <div class="carousel-indicators">
                <span class="carousel-indicator"></span>
                <span class="carousel-indicator"></span>
                <span class="carousel-indicator"></span>
            </div>
        </div>
        
        <div class="test-controls">
            <button id="startTestBtn" class="btn btn-primary">开始测试</button>
            <button id="stopTestBtn" class="btn btn-danger">停止测试</button>
            <button id="resetTestBtn" class="btn btn-primary">重置测试</button>
            <button id="goToThirdBtn" class="btn btn-primary">直接跳到第三张</button>
        </div>
        
        <h2>2. 修复后的轮播代码</h2>
        <div class="code-section">
// 修复后的轮播图循环逻辑
function startCarousel() {
  // 自动轮播
  let intervalId = setInterval(() => {
    console.log(`当前索引: ${currentIndex}, 幻灯片数量: ${slides.length}`);
    const nextIndex = (currentIndex + 1) % slides.length;
    console.log(`计算下一张索引: (${currentIndex} + 1) % ${slides.length} = ${nextIndex}`);
    
    // 特别检查从最后一张到第一张的循环
    if (currentIndex === slides.length - 1) {
      console.log(`检测到循环点: 从第${slides.length}张到第1张`);
    }
    
    currentIndex = nextIndex;
    showSlide(currentIndex);
  }, 5000);
  console.log('启动自动轮播 (5秒间隔)');
}
        </div>
        
        <h2>3. 调试变量</h2>
        <div class="debug-vars">
            <div class="debug-var">
                <strong>slides.length:</strong> <span id="slidesLength">3</span>
            </div>
            <div class="debug-var">
                <strong>currentIndex:</strong> <span id="currentIndex">0</span>
            </div>
            <div class="debug-var">
                <strong>轮播状态:</strong> <span id="carouselStatus">未启动</span>
            </div>
            <div class="debug-var">
                <strong>测试运行时间:</strong> <span id="testRuntime">0秒</span>
            </div>
            <div class="debug-var">
                <strong>循环次数:</strong> <span id="cycleCount">0</span>
            </div>
        </div>
        
        <h2>4. 测试日志</h2>
        <div class="log-container" id="logContainer">
            <div class="log-entry">
                <span class="log-time">[${new Date().toLocaleTimeString()}]</span>
                <span class="log-info">测试页面已加载</span>
            </div>
        </div>
        
        <h2>5. 轮播图循环模拟</h2>
        <div class="simulation-section">
            <div class="simulation-step">
                <strong>步骤 1:</strong> 当前显示图片 1 (index = 0)
            </div>
            <div class="simulation-step">
                <strong>步骤 2:</strong> 5秒后切换到图片 2 (index = 1)
            </div>
            <div class="simulation-step">
                <strong>步骤 3:</strong> 5秒后切换到图片 3 (index = 2)
            </div>
            <div class="simulation-step" id="criticalStep">
                <strong>关键步骤 4:</strong> 5秒后应该切换回图片 1 (index = 0) - 这是我们需要验证的循环点
            </div>
        </div>
        
        <h2>6. 测试结果</h2>
        <div id="testResult" class="status-box status-info">
            <p>测试尚未开始。点击上方的"开始测试"按钮启动测试。</p>
        </div>
    </div>

    <script>
        // 初始化变量
        let currentIndex = 0;
        let intervalId = null;
        let testStartTime = null;
        let testRunning = false;
        let cycleCount = 0;
        let testPassed = false;
        let testFailed = false;
        
        // 获取DOM元素
        const slides = document.querySelectorAll('.carousel-slide');
        const indicators = document.querySelectorAll('.carousel-indicator');
        const logContainer = document.getElementById('logContainer');
        const startTestBtn = document.getElementById('startTestBtn');
        const stopTestBtn = document.getElementById('stopTestBtn');
        const resetTestBtn = document.getElementById('resetTestBtn');
        const goToThirdBtn = document.getElementById('goToThirdBtn');
        const slidesLengthElement = document.getElementById('slidesLength');
        const currentIndexElement = document.getElementById('currentIndex');
        const carouselStatusElement = document.getElementById('carouselStatus');
        const testRuntimeElement = document.getElementById('testRuntime');
        const cycleCountElement = document.getElementById('cycleCount');
        const testResultElement = document.getElementById('testResult');
        const criticalStepElement = document.getElementById('criticalStep');
        
        // 显示幻灯片函数 - 模拟main.js中的实现
        function showSlide(index) {
            // 确保索引在有效范围内
            index = Math.max(0, Math.min(index, slides.length - 1));
            currentIndex = index;
            
            // 更新显示的幻灯片
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
                slide.style.opacity = i === index ? '1' : '0';
                slide.style.zIndex = i === index ? '2' : '1';
            });
            
            // 更新指示器
            indicators.forEach((indicator, i) => {
                indicator.classList.toggle('active', i === index);
            });
            
            // 更新调试变量显示
            currentIndexElement.textContent = currentIndex;
            
            // 记录日志
            log(`切换到幻灯片 ${index + 1}`);
            
            // 检查是否从第三张图片回到第一张图片
            if (index === 0 && cycleCount > 0) {
                log(`检测到循环切换: 第三张图片 -> 第一张图片`, 'success');
                log(`循环逻辑正常工作: (currentIndex + 1) % slides.length = ${(3-1 + 1) % 3}`, 'success');
                testPassed = true;
                cycleCount++;
                cycleCountElement.textContent = cycleCount;
                criticalStepElement.style.backgroundColor = '#d4edda';
                criticalStepElement.style.borderLeftColor = '#28a745';
                updateTestResult();
            }
            
            // 如果是第三张图片，增加循环计数
            if (index === slides.length - 1) {
                if (cycleCount === 0) {
                    // 第一次到达第三张图片
                    cycleCount = 1;
                } else {
                    // 再次到达第三张图片，说明已经完成了一次循环
                    cycleCount++;
                }
                cycleCountElement.textContent = cycleCount;
                log(`到达最后一张图片 (第${index + 1}张)，等待5秒后应该回到第一张图片`, 'info');
                criticalStepElement.style.backgroundColor = '#fff3cd';
                criticalStepElement.style.borderLeftColor = '#ffc107';
            }
        }
        
        // 开始轮播 - 使用修复后的逻辑
        function startCarousel() {
            if (intervalId) {
                clearInterval(intervalId);
            }
            
            // 自动轮播 - 每5秒切换一次
            intervalId = setInterval(() => {
                console.log(`当前索引: ${currentIndex}, 幻灯片数量: ${slides.length}`);
                const nextIndex = (currentIndex + 1) % slides.length;
                console.log(`计算下一张索引: (${currentIndex} + 1) % ${slides.length} = ${nextIndex}`);
                
                // 特别检查从最后一张到第一张的循环
                if (currentIndex === slides.length - 1) {
                    console.log(`检测到循环点: 从第${slides.length}张到第1张`);
                    log(`检测到循环点: 从第${slides.length}张到第1张`, 'info');
                }
                
                currentIndex = nextIndex;
                showSlide(currentIndex);
            }, 5000);
            
            log('启动自动轮播 (5秒间隔)');
            carouselStatusElement.textContent = '运行中';
        }
        
        // 停止轮播
        function stopCarousel() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                log('停止自动轮播');
                carouselStatusElement.textContent = '已停止';
            }
        }
        
        // 重置测试
        function resetTest() {
            stopCarousel();
            currentIndex = 0;
            cycleCount = 0;
            testPassed = false;
            testFailed = false;
            testRunning = false;
            testStartTime = null;
            
            showSlide(0);
            log('重置测试');
            
            slidesLengthElement.textContent = slides.length;
            currentIndexElement.textContent = currentIndex;
            carouselStatusElement.textContent = '未启动';
            testRuntimeElement.textContent = '0秒';
            cycleCountElement.textContent = cycleCount;
            
            testResultElement.className = 'status-box status-info';
            testResultElement.innerHTML = '<p>测试已重置。点击上方的"开始测试"按钮启动测试。</p>';
            
            criticalStepElement.style.backgroundColor = '';
            criticalStepElement.style.borderLeftColor = '#3498db';
        }
        
        // 直接跳到第三张图片
        function goToThirdSlide() {
            if (testRunning) {
                stopCarousel();
                currentIndex = 2;
                showSlide(currentIndex);
                log('手动跳转到第三张图片');
                
                // 继续轮播，测试从第三张到第一张的切换
                setTimeout(() => {
                    log('继续轮播，测试从第三张到第一张的切换');
                    startCarousel();
                }, 1000);
            } else {
                currentIndex = 2;
                showSlide(currentIndex);
                log('手动跳转到第三张图片');
            }
        }
        
        // 添加日志
        function log(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            logEntry.innerHTML = `
                <span class="log-time">[${timeString}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 更新测试运行时间
        function updateRuntime() {
            if (!testRunning || !testStartTime) return;
            
            const now = new Date();
            const runtime = Math.floor((now - testStartTime) / 1000);
            testRuntimeElement.textContent = `${runtime}秒`;
            
            // 如果运行时间超过60秒，停止测试并显示超时
            if (runtime > 60 && !testPassed && !testFailed) {
                stopTest();
                testFailed = true;
                log('测试超时: 60秒内未完成预期的循环', 'error');
                testResultElement.className = 'status-box status-error';
                testResultElement.innerHTML = '<p>测试失败: 轮播图没有在预期时间内从第三张图片回到第一张图片。</p>';
                criticalStepElement.style.backgroundColor = '#f8d7da';
                criticalStepElement.style.borderLeftColor = '#dc3545';
            }
        }
        
        // 更新测试结果
        function updateTestResult() {
            if (testPassed) {
                stopTest();
                testResultElement.className = 'status-box status-success';
                testResultElement.innerHTML = '<p>测试成功: 轮播图正确地从第三张图片回到了第一张图片！</p>';
                log('测试完成 - 成功', 'success');
            }
        }
        
        // 开始测试
        function startTest() {
            if (testRunning) return;
            
            testRunning = true;
            testStartTime = new Date();
            log('开始轮播图循环测试');
            log(`测试配置: ${slides.length}张图片，每5秒切换一次`);
            
            startCarousel();
            
            // 开始更新运行时间
            setInterval(updateRuntime, 1000);
        }
        
        // 停止测试
        function stopTest() {
            if (!testRunning) return;
            
            testRunning = false;
            stopCarousel();
            log('停止轮播图循环测试');
        }
        
        // 绑定事件处理程序
        startTestBtn.addEventListener('click', startTest);
        stopTestBtn.addEventListener('click', stopTest);
        resetTestBtn.addEventListener('click', resetTest);
        goToThirdBtn.addEventListener('click', goToThirdSlide);
        
        // 初始化
        slidesLengthElement.textContent = slides.length;
        showSlide(0);
    </script>
</body>
</html>